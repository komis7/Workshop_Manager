@{
    ViewData["Title"] = "Home Page";
    var workshops = ViewBag.Workshops as IEnumerable<dynamic>;

    string FormatPhone(string p)
    {
        if (string.IsNullOrWhiteSpace(p)) return "";

        var digits = new string(p.Where(char.IsDigit).ToArray());

        // standard PL: 9 cyfr → 123 456 789
        if (digits.Length == 9)
        {
            return $"{digits[..3]} {digits.Substring(3, 3)} {digits.Substring(6, 3)}";
        }

        return p;
    }

 }

<div class="container-fluid px-0">

     <div class="home-header">
        <h1 class="text-center mb-4 display-6 border-bottom pb-3 workshop-heading">
            Wybierz swój warsztat
        </h1>
    </div>

        <!-- Pasek wyszukiwania / filtry -->
        <div class="row align-items-center g-2 mb-4">
            <div class="col-12 col-md">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="workshopSearch" type="search" class="form-control" placeholder="Szukaj po nazwie, adresie lub usłudze…" aria-label="Szukaj warsztatów">
                </div>
            </div>
            <div class="col-auto">
                <span class="text-secondary small"><span id="workshopCount">0</span> wyników</span>
            </div>
        </div>


    <div id="workshopsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
        @if (workshops != null && workshops.Any())
        {
            foreach (var workshop in workshops)
            {
                var company = (string)workshop.CompanyName ?? "";
                var phone = (string)workshop.PhoneNumber ?? "";
                var address = (string)workshop.Address ?? "";
                var services = (string)workshop.Services ?? "";
                var rate = (int?)workshop.HourlyRate;

                <div class="col">
                    <div class="card h-100 shadow-sm border-0 rounded-4 workshop-card hover-elevate"
                         data-search-text="@($"{company} {address} {services}".ToLowerInvariant())">
                        <div class="card-body">
                            <h5 class="card-title mb-2 text-primary fw-bold">
                                <i class="bi bi-building me-1"></i>@company
                            </h5>
                            <ul class="list-unstyled small mb-0 text-secondary">
                                @if (!string.IsNullOrWhiteSpace(phone))
                                {
                                    <li class="mb-2 workshop-phone">
                                        <i class="bi bi-telephone me-2"></i>
                                        <a class="link-body-emphasis text-decoration-none" href="tel:@phone">@FormatPhone(phone)</a>
                                    </li>
                                }
                                @if (!string.IsNullOrWhiteSpace(address))
                                {
                                    <li class="mb-1">
                                        <i class="bi bi-geo-alt me-1"></i>@address
                                    </li>
                                }
                                @if (!string.IsNullOrWhiteSpace(services))
                                {
                                    <li class="mb-1">
                                        <strong>Usługi:</strong> @services
                                    </li>
                                }
                            @if (rate != null)
                                {
                                    <li class="mb-1">
                                        <strong>Stawka:</strong> @rate zł/h
                                    </li>
                                }
                            </ul>
                        </div>

                        <div class="card-footer bg-transparent border-0 text-center pt-0 pb-3">
                            <a asp-controller="Workshop"
                               asp-action="Schedule"
                               asp-route-id="@workshop.Id"
                               class="btn btn-outline-primary px-4">
                                <i class="bi bi-calendar-check me-1"></i> Umów wizytę
                            </a>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-secondary text-center rounded-3 mb-0">
                    Brak warsztatów do wyświetlenia.
                </div>
            </div>
        }
    </div>
</div>
@section Scripts {
    <script>
        (function () {
            const input = document.getElementById('workshopSearch');
            const grid = document.getElementById('workshopsGrid');
            const cards = Array.from(grid.querySelectorAll('.workshop-card')).map(card => ({
                el: card,
                haystack: (card.getAttribute('data-search-text') || '').trim()
            }));
            const counter = document.getElementById('workshopCount');

            function applyFilter() {
                const q = (input.value || '').toLowerCase().trim();
                let visible = 0;
                cards.forEach(c => {
                    const match = !q || c.haystack.includes(q);
                    c.el.parentElement.style.display = match ? '' : 'none'; // .col wrapper
                    if (match) visible++;
                });
                counter.textContent = visible;
            }

            // Inicjalizacja licznika
            applyFilter();

            input.addEventListener('input', applyFilter);
        })();
    </script>
}

