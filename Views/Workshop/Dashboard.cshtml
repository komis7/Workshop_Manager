@using System.Text.Json
@model WorkShopManager.Models.WorkshopEditProfileViewModel

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header text-center bg-secondary text-white">
                    <h3>Edycja danych warsztatu</h3>
                </div>

                <div class="card-body">
                    <div asp-validation-summary="All" class="alert alert-danger d-none" role="alert"></div>

                    <form asp-action="Dashboard" method="post" novalidate>

                        <h5 class="text-secondary">Informacje o warsztacie</h5>
                        <hr />

                        <div class="mb-3">
                            <label asp-for="CompanyName" class="form-label">Nazwa firmy</label>
                            <input asp-for="CompanyName" class="form-control" />
                            <span asp-validation-for="CompanyName" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label asp-for="Street" class="form-label">Ulica</label>
                                <input asp-for="Street" class="form-control" />
                                <span asp-validation-for="Street" class="text-danger"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="BuildingNumber" class="form-label">Numer budynku</label>
                                <input asp-for="BuildingNumber" class="form-control" />
                                <span asp-validation-for="BuildingNumber" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="PostalCode" class="form-label">Kod pocztowy</label>
                                <input asp-for="PostalCode" class="form-control" />
                                <span asp-validation-for="PostalCode" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="City" class="form-label">Miasto</label>
                                <input asp-for="City" class="form-control" />
                                <span asp-validation-for="City" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="CompanyNIP" class="form-label">NIP firmy</label>
                            <input asp-for="CompanyNIP" class="form-control" />
                            <span asp-validation-for="CompanyNIP" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="PhoneNumber" class="form-label">Numer telefonu</label>
                            <input asp-for="PhoneNumber" class="form-control" />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>

@*                         <div class="mb-3">
                            <label asp-for="WorkshopSlots" class="form-label">Ilość stanowisk warsztatowych</label>
                            <input asp-for="WorkshopSlots" type="number" class="form-control" min="1" />
                            <span asp-validation-for="WorkshopSlots" class="text-danger"></span>
                        </div> *@

                        <h5 class="text-secondary">Usługi warsztatowe</h5>
                        <hr />

                        @{
                            var predefined = new HashSet<string>(
                            WorkShopManager.Models.WorkshopEditProfileViewModel.AvailableServices.Select(s => s.Trim()),
                            StringComparer.OrdinalIgnoreCase
                            );

                            // Aktywne (zaznaczone) – z Services
                            var active = new HashSet<string>(
                            (Model.SelectedServices ?? new List<string>())
                            .Select(s => (s ?? "").Trim())
                            .Where(s => !string.IsNullOrWhiteSpace(s)),
                            StringComparer.OrdinalIgnoreCase
                            );

                            // Stała lista custom – z CustomServicesCsv
                            var custom = new HashSet<string>(
                            (Model.CustomServices ?? new List<string>())
                            .Select(s => (s ?? "").Trim())
                            .Where(s => !string.IsNullOrWhiteSpace(s)),
                            StringComparer.OrdinalIgnoreCase
                            );
                        }

                        <div class="mb-3">
                            <label class="form-label">Twoja lista usług (odznaczenie = nieaktywna, ale zostaje na liście):</label>

                            <div class="row" id="servicesCheckboxGrid">
                                @* Predefiniowane *@
                                @foreach (var service in WorkShopManager.Models.WorkshopEditProfileViewModel.AvailableServices)
                                {
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   value="@service"
                                                   name="SelectedServices"
                                                   @(active.Contains(service) ? "checked" : "") />
                                            <label class="form-check-label">@service</label>
                                        </div>
                                    </div>
                                }

                                @* Własne – ZAWSZE widoczne jako checkboxy *@
                                @foreach (var service in custom.OrderBy(s => s))
                                {
                                    <div class="col-md-6 custom-service-item">
                                        <div class="form-check d-flex align-items-center justify-content-between gap-2">
                                            <div>
                                                <input class="form-check-input custom-service-checkbox"
                                                       type="checkbox"
                                                       value="@service"
                                                       name="SelectedServices"
                                                       @(active.Contains(service) ? "checked" : "") />
                                                <label class="form-check-label">
                                                    @service <span class="text-muted">(własna)</span>
                                                </label>

                                                @* STAŁA lista – hiddeny, żeby custom wracały zawsze nawet jak odznaczone *@
                                                <input type="hidden" name="CustomServices" value="@service" />
                                            </div>

                                            @* Opcjonalnie: przycisk usuwania z listy stałej *@
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger remove-custom-btn"
                                                    data-service="@service">
                                                Usuń
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>

                            <hr />
                            <h6 class="mt-3">Dodaj własną usługę</h6>

                            <div class="input-group mb-2">
                                <input asp-for="NewService" id="newServiceInput" class="form-control" placeholder="np. Wymiana rozrządu" />
                                <button type="button" id="addServiceBtn" class="btn btn-outline-light">Dodaj</button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="HourlyRate" class="form-label">Stawka godzinowa (PLN)</label>
                            <input asp-for="HourlyRate" type="number" step="1" min="1" class="form-control" />
                            <span asp-validation-for="HourlyRate" class="text-danger"></span>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-secondary btn-lg">Zapisz</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    @if (TempData["SavedOk"] != null)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const msg = @Html.Raw(JsonSerializer.Serialize(TempData["SavedOk"]?.ToString()));
                alert(msg);
            });
        </script>
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('newServiceInput');
            const btn = document.getElementById('addServiceBtn');
            const grid = document.getElementById('servicesCheckboxGrid');

            function norm(s) { return (s || '').trim().toLowerCase(); }

            function existingAllServicesSet() {
                // sprawdzamy zarówno checkboxy, jak i hidden CustomServices
                const set = new Set();

                document.querySelectorAll('input[name="SelectedServices"][type="checkbox"]')
                    .forEach(cb => set.add(norm(cb.value)));

                document.querySelectorAll('input[name="CustomServices"][type="hidden"]')
                    .forEach(h => set.add(norm(h.value)));

                return set;
            }

            function createCustomRow(serviceName) {
                const col = document.createElement('div');
                col.className = 'col-md-6 custom-service-item';

                const wrap = document.createElement('div');
                wrap.className = 'form-check d-flex align-items-center justify-content-between gap-2';

                const left = document.createElement('div');

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.name = 'SelectedServices';
                cb.value = serviceName;
                cb.checked = true; // nowa = domyślnie aktywna
                cb.className = 'form-check-input custom-service-checkbox';

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.innerHTML = `${serviceName} <span class="text-muted">(własna)</span>`;

                // hidden w stałej liście (żeby wracało po odznaczeniu)
                const hidden = document.createElement('input');
                hidden.type = 'hidden';
                hidden.name = 'CustomServices';
                hidden.value = serviceName;

                left.appendChild(cb);
                left.appendChild(label);
                left.appendChild(hidden);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-sm btn-outline-danger remove-custom-btn';
                removeBtn.dataset.service = serviceName;
                removeBtn.textContent = 'Usuń';

                wrap.appendChild(left);
                wrap.appendChild(removeBtn);
                col.appendChild(wrap);

                return col;
            }

            function addService() {
                const service = (input.value || '').trim();
                if (service.length < 3) {
                    alert('Nazwa usługi musi mieć co najmniej 3 znaki.');
                    return;
                }

                const set = existingAllServicesSet();
                if (set.has(norm(service))) {
                    alert('Taka usługa już istnieje na liście.');
                    return;
                }

                grid.appendChild(createCustomRow(service));

                input.value = '';
                input.focus();
            }

            btn?.addEventListener('click', addService);

            input?.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addService();
                }
            });

            // usuwanie z listy stałej (usuwa checkbox + hidden CustomServices)
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.remove-custom-btn');
                if (!btn) return;

                const service = btn.dataset.service || '';
                if (!service) return;

                if (!confirm(`Usunąć usługę "${service}" z Twojej listy?`)) return;

                const item = btn.closest('.custom-service-item');
                if (item) item.remove();
            });
        });
    </script>
}
